import React, { useState } from "react";

const AddFinTrans = ({ sessionUser }) => {
  const [propertyCode, setPropertyCode] = useState("");
  const [property, setProperty] = useState(null);
  const [tenant, setTenant] = useState(null);
  const [formData, setFormData] = useState({});

  // ------------------- Search by Property Code -------------------
  const handleSearch = async (e) => {
    e.preventDefault();
    try {
      const res = await fetch(`http://localhost:5000/property/${propertyCode}`);
      const data = await res.json();

      if (!data.success) return alert(data.message || "Property not found");

      const propertyDetails = data.property;
      const contract = data.contract || {};
      const tenantDetails = data.tenant || {};

      setProperty({
        property_code: propertyDetails.property_code,
        building_name: propertyDetails.building_name,
        building_type: propertyDetails.building_type,
      });

      setTenant({
        TenantName: tenantDetails.tenant_name,
        TenantID: tenantDetails.tenant_id,
      });

      setFormData({
        property_code: propertyDetails.property_code || "",
        tenancy_contract_number: contract.tenancy_contract_number || "",
        tenant_id: tenantDetails.tenant_id || "",
        tenant_name: tenantDetails.tenant_name || "",
        created_by: sessionUser || "admin",
        creation_date: new Date().toISOString().split("T")[0],
      });
    } catch (err) {
      console.error("Error fetching property data:", err);
      alert("Error fetching property data!");
    }
  };

  // ------------------- Handle Change -------------------
  const handleChange = (e) => {
    const { name, value, files } = e.target;
    if (files) {
      setFormData((prev) => ({ ...prev, [name]: files[0] }));
    } else {
      setFormData((prev) => ({ ...prev, [name]: value }));
    }
  };

  // ------------------- Mode Change Logic -------------------
  const handleModeChange = (e) => {
    const value = e.target.value;

    // Reset mode-specific fields
    setFormData((prev) => ({
      ...prev,
      mode_of_payment: value,
      tr_date: "",
      tr_amount: "",
      reference_number: "",
      cheque_date: "",
      bank_name: "",
      bank_city: "",
      ifsc_code: "",
      cheque_image: null,
      cheque_status: "",
    }));
  };

  // ------------------- Submit Form -------------------
  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!property) return alert("Please search and select a valid Property first");

    const data = new FormData();
    Object.keys(formData).forEach((key) => {
      data.append(key, formData[key]);
    });

    try {
      const res = await fetch("http://localhost:5000/add_fintrans", {
        method: "POST",
        credentials: "include",
        body: data,
      });

      const result = await res.json();

      if (res.ok && result.success) {
        alert(`✅ ${result.message}`);
        setProperty(null);
        setTenant(null);
        setFormData({});
        setPropertyCode("");
      } else {
        alert(`❌ ${result.message || "Failed to add financial transaction"}`);
      }
    } catch (err) {
      console.error("Error submitting form:", err);
      alert("❌ Error submitting financial transaction");
    }
  };

  // ------------------- Options -------------------
  const receiptPaymentOptions = ["Receipt", "Payment"];
  const reasonOptions = [
    "Rent Deposit",
    "Rent",
    "Refund",
    "ElecBill",
    "WaterBill",
    "Munc. Number",
  ];
  const paymentModes = ["Cash", "Cheque", "Online"];
  const chequeStatuses = ["Cleared", "Bounced"];

  // ------------------- Form Layout -------------------
  return (
    <div style={{ fontFamily: "Arial, sans-serif", padding: "20px" }}>
      <h2
        style={{
          textAlign: "center",
          background: "#2f3640",
          color: "white",
          padding: "15px 0",
        }}
      >
        Add Financial Transaction
      </h2>

      {/* Search by Property Code */}
      <form
        onSubmit={handleSearch}
        style={{ textAlign: "center", margin: "20px 0" }}
      >
        <label>Enter Property Code:</label>
        <input
          type="text"
          value={propertyCode}
          onChange={(e) => setPropertyCode(e.target.value)}
          placeholder="Ex: 1001"
          required
          style={{ margin: "0 10px", padding: "5px", width: 120 }}
        />
        <button
          type="submit"
          style={{ padding: "5px 10px", cursor: "pointer", width: 100 }}
        >
          Search
        </button>
      </form>

      {/* Main Form */}
      {property && (
        <form onSubmit={handleSubmit}>
          <div
            style={{
              display: "grid",
              gridTemplateColumns: "repeat(4, 1fr)",
              gap: "10px",
              marginBottom: "15px",
            }}
          >
            {/* Readonly Fields */}
            <div>
              <label style={{ fontWeight: "bold" }}>PROPERTY CODE</label>
              <input
                type="text"
                name="property_code"
                value={formData.property_code || ""}
                readOnly
                style={{ backgroundColor: "#f0f0f0" }}
              />
            </div>

            <div>
              <label style={{ fontWeight: "bold" }}>TENANT NAME</label>
              <input
                type="text"
                name="tenant_name"
                value={formData.tenant_name || ""}
                readOnly
                style={{ backgroundColor: "#f0f0f0" }}
              />
            </div>

            <div>
              <label style={{ fontWeight: "bold" }}>TENANCY CONTRACT</label>
              <input
                type="text"
                name="tenancy_contract_number"
                value={formData.tenancy_contract_number || ""}
                readOnly
                style={{ backgroundColor: "#f0f0f0" }}
              />
            </div>

            {/* Receipt / Payment */}
            <div>
              <label style={{ fontWeight: "bold" }}>RECEIPT / PAYMENT</label>
              <div>
                {receiptPaymentOptions.map((opt) => (
                  <label key={opt} style={{ marginRight: "10px" }}>
                    <input
                      type="radio"
                      name="receipt_payment"
                      value={opt}
                      checked={formData.receipt_payment === opt}
                      onChange={handleChange}
                    />{" "}
                    {opt}
                  </label>
                ))}
              </div>
            </div>

            {/* Reason */}
            <div>
              <label style={{ fontWeight: "bold" }}>REASON</label>
              <select
                name="receipt_payment_reason"
                value={formData.receipt_payment_reason || ""}
                onChange={handleChange}
              >
                <option value="">Select</option>
                {reasonOptions.map((r) => (
                  <option key={r} value={r}>
                    {r}
                  </option>
                ))}
              </select>
            </div>

            {/* Mode of Payment */}
            <div>
              <label style={{ fontWeight: "bold" }}>MODE OF PAYMENT</label>
              <select
                name="mode_of_payment"
                value={formData.mode_of_payment || ""}
                onChange={handleModeChange}
              >
                <option value="">Select</option>
                {paymentModes.map((m) => (
                  <option key={m} value={m}>
                    {m}
                  </option>
                ))}
              </select>
            </div>

            {/* Conditional Fields */}
            {formData.mode_of_payment === "Cash" && (
              <>
                <div>
                  <label style={{ fontWeight: "bold" }}>TRANSACTION DATE</label>
                  <input
                    type="date"
                    name="tr_date"
                    value={formData.tr_date || ""}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label style={{ fontWeight: "bold" }}>TRANSACTION AMOUNT</label>
                  <input
                    type="number"
                    step="0.01"
                    name="tr_amount"
                    value={formData.tr_amount || ""}
                    onChange={handleChange}
                  />
                </div>
              </>
            )}

            {formData.mode_of_payment === "Online" && (
              <>
                <div>
                  <label style={{ fontWeight: "bold" }}>TRANSACTION DATE</label>
                  <input
                    type="date"
                    name="tr_date"
                    value={formData.tr_date || ""}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label style={{ fontWeight: "bold" }}>TRANSACTION AMOUNT</label>
                  <input
                    type="number"
                    step="0.01"
                    name="tr_amount"
                    value={formData.tr_amount || ""}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label style={{ fontWeight: "bold" }}>REFERENCE NUMBER</label>
                  <input
                    type="text"
                    name="reference_number"
                    value={formData.reference_number || ""}
                    onChange={handleChange}
                  />
                </div>
              </>
            )}

            {formData.mode_of_payment === "Cheque" && (
              <>
                <div>
                  <label style={{ fontWeight: "bold" }}>TRANSACTION DATE</label>
                  <input
                    type="date"
                    name="tr_date"
                    value={formData.tr_date || ""}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label style={{ fontWeight: "bold" }}>TRANSACTION AMOUNT</label>
                  <input
                    type="number"
                    step="0.01"
                    name="tr_amount"
                    value={formData.tr_amount || ""}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label style={{ fontWeight: "bold" }}>CHEQUE DATE</label>
                  <input
                    type="date"
                    name="cheque_date"
                    value={formData.cheque_date || ""}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label style={{ fontWeight: "bold" }}>BANK NAME</label>
                  <input
                    type="text"
                    name="bank_name"
                    value={formData.bank_name || ""}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label style={{ fontWeight: "bold" }}>BANK CITY</label>
                  <input
                    type="text"
                    name="bank_city"
                    value={formData.bank_city || ""}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label style={{ fontWeight: "bold" }}>IFSC CODE</label>
                  <input
                    type="text"
                    name="ifsc_code"
                    value={formData.ifsc_code || ""}
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label style={{ fontWeight: "bold" }}>CHEQUE IMAGE</label>
                  <input
                    type="file"
                    name="cheque_image"
                    accept="image/*"
                    onChange={handleChange}
                  />
                </div>
                <div>
                  <label style={{ fontWeight: "bold" }}>CHEQUE STATUS</label>
                  <select
                    name="cheque_status"
                    value={formData.cheque_status || ""}
                    onChange={handleChange}
                  >
                    <option value="">Select</option>
                    {chequeStatuses.map((s) => (
                      <option key={s} value={s}>
                        {s}
                      </option>
                    ))}
                  </select>
                </div>
              </>
            )}
          </div>

          {/* Buttons */}
          <div style={{ textAlign: "center", marginTop: "30px" }}>
            <a
              href="/index"
              style={{
                width: 200,
                padding: "10px 20px",
                backgroundColor: "#492bc0ff",
                color: "white",
                borderRadius: "6px",
                textDecoration: "none",
                marginRight: "20px",
                display: "inline-block",
              }}
            >
              ← Go Back Home
            </a>
            <button
              type="submit"
              style={{
                width: 200,
                padding: "10px 20px",
                backgroundColor: "#27ae60",
                color: "white",
                border: "none",
                borderRadius: "6px",
                cursor: "pointer",
                fontSize: "16px",
              }}
            >
              Add Transaction
            </button>
          </div>
        </form>
      )}
    </div>
  );
};

export default AddFinTrans;
